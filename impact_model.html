<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>impact_model.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1667526-20']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
  <style type="text/css">
    td.docs h1 {
      margin-top: 0;
    }
    @media print {
      .code pre {
        white-space: pre-wrap;
      }
      .code {
        padding-left: 0 !important;
        padding-right: 0 !important;
      }
      .code .highlight {
        margin-left: 15px;
        margin-right: 15px;
      }
    }
  </style>
</head>

<body>
<div id='container'>
  <div id="background"></div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>impact_model.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p>Copyright Â© 2010 Brighter Planet.
See LICENSE for details.
Contact Brighter Planet for dual-license arrangements.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;weighted_average&#39;</span>

<span class="k">module</span> <span class="nn">BrighterPlanet</span>
  <span class="k">module</span> <span class="nn">Pet</span>
    <span class="k">module</span> <span class="nn">ImpactModel</span>
      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">included</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
        <span class="n">base</span><span class="o">.</span><span class="n">decide</span> <span class="ss">:impact</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="ss">:characteristics</span> <span class="k">do</span>
          <span class="n">committee</span> <span class="ss">:carbon</span> <span class="k">do</span>
            <span class="n">quorum</span> <span class="s1">&#39;from diet size&#39;</span><span class="p">,</span> <span class="ss">:needs</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:diet_size</span><span class="p">,</span> <span class="ss">:diet_emission_intensity</span><span class="p">,</span> <span class="ss">:active_subtimeframe</span><span class="o">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">|</span>
              <span class="n">characteristics</span><span class="o">[</span><span class="ss">:active_subtimeframe</span><span class="o">].</span><span class="n">days</span> <span class="o">*</span> <span class="n">characteristics</span><span class="o">[</span><span class="ss">:diet_size</span><span class="o">]</span> <span class="o">*</span> <span class="n">characteristics</span><span class="o">[</span><span class="ss">:diet_emission_intensity</span><span class="o">]</span> <span class="o">+</span> <span class="no">ANNUAL_VETERINARY_EMISSION</span> <span class="o">*</span> <span class="p">(</span><span class="n">characteristics</span><span class="o">[</span><span class="ss">:active_subtimeframe</span><span class="o">]</span> <span class="o">/</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
            <span class="k">end</span>
          <span class="k">end</span>
          
          <span class="n">committee</span> <span class="ss">:diet_emission_intensity</span> <span class="k">do</span> <span class="c1"># kg/joule</span>
            <span class="n">quorum</span> <span class="s1">&#39;from species&#39;</span><span class="p">,</span> <span class="ss">:needs</span> <span class="o">=&gt;</span> <span class="ss">:species</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="o">|</span>
              <span class="n">characteristics</span><span class="o">[</span><span class="ss">:species</span><span class="o">].</span><span class="n">diet_emission_intensity</span>
            <span class="k">end</span>
            
            <span class="n">quorum</span> <span class="s1">&#39;default&#39;</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>sabshere 2/10/11 pulled from Species.fallback
kg CO2 / joule</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>              <span class="no">Species</span><span class="o">.</span><span class="n">weighted_average</span> <span class="ss">:diet_emission_intensity</span><span class="p">,</span> <span class="ss">:weighted_by</span> <span class="o">=&gt;</span> <span class="ss">:population</span>
            <span class="k">end</span>
          <span class="k">end</span>
          
          <span class="n">committee</span> <span class="ss">:diet_size</span> <span class="k">do</span> <span class="c1"># joules</span>
            <span class="n">quorum</span> <span class="s1">&#39;from weight&#39;</span><span class="p">,</span> <span class="ss">:needs</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:weight</span><span class="p">,</span> <span class="ss">:marginal_dietary_requirement</span><span class="p">,</span> <span class="ss">:fixed_dietary_requirement</span><span class="o">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="o">|</span>
              <span class="n">characteristics</span><span class="o">[</span><span class="ss">:weight</span><span class="o">]</span> <span class="o">*</span> <span class="n">characteristics</span><span class="o">[</span><span class="ss">:marginal_dietary_requirement</span><span class="o">]</span> <span class="o">+</span> <span class="n">characteristics</span><span class="o">[</span><span class="ss">:fixed_dietary_requirement</span><span class="o">]</span>
            <span class="k">end</span>
          <span class="k">end</span>
          
          <span class="n">committee</span> <span class="ss">:marginal_dietary_requirement</span> <span class="k">do</span> <span class="c1"># joules/kg</span>
            <span class="n">quorum</span> <span class="s1">&#39;from species&#39;</span><span class="p">,</span> <span class="ss">:needs</span> <span class="o">=&gt;</span> <span class="ss">:species</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="o">|</span>
              <span class="n">characteristics</span><span class="o">[</span><span class="ss">:species</span><span class="o">].</span><span class="n">marginal_dietary_requirement</span>
            <span class="k">end</span>
      
            <span class="n">quorum</span> <span class="s1">&#39;default&#39;</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>sabshere 2/10/11 pulled from Species.fallback</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>              <span class="no">Species</span><span class="o">.</span><span class="n">marginal_dietary_requirement_fallback</span>
            <span class="k">end</span>
          <span class="k">end</span>
          
          <span class="n">committee</span> <span class="ss">:fixed_dietary_requirement</span> <span class="k">do</span> <span class="c1"># joules</span>
            <span class="n">quorum</span> <span class="s1">&#39;from species&#39;</span><span class="p">,</span> <span class="ss">:needs</span> <span class="o">=&gt;</span> <span class="ss">:species</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="o">|</span>
              <span class="n">characteristics</span><span class="o">[</span><span class="ss">:species</span><span class="o">].</span><span class="n">fixed_dietary_requirement</span>
            <span class="k">end</span>
      
            <span class="n">quorum</span> <span class="s1">&#39;default&#39;</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>sabshere 2/10/11 pulled from Species.fallback
force a zero intercept to be respectful of our tiny tiny animal friends</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>              <span class="mi">0</span><span class="o">.</span><span class="mi">0</span>
            <span class="k">end</span>
          <span class="k">end</span>
          
          <span class="n">committee</span> <span class="ss">:weight</span> <span class="k">do</span> <span class="c1"># kg</span>
            <span class="n">quorum</span> <span class="s1">&#39;from breed and gender&#39;</span><span class="p">,</span> <span class="ss">:needs</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:breed</span><span class="p">,</span> <span class="ss">:gender</span><span class="o">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="o">|</span>
              <span class="k">if</span> <span class="n">breed_gender</span> <span class="o">=</span> <span class="no">BreedGender</span><span class="o">.</span><span class="n">find_by_breed_name_and_gender_name</span><span class="p">(</span><span class="n">characteristics</span><span class="o">[</span><span class="ss">:breed</span><span class="o">].</span><span class="n">name</span><span class="p">,</span> <span class="n">characteristics</span><span class="o">[</span><span class="ss">:gender</span><span class="o">].</span><span class="n">name</span><span class="p">)</span>
                <span class="n">breed_gender</span><span class="o">.</span><span class="n">weight</span>
              <span class="k">end</span>
            <span class="k">end</span>
            
            <span class="n">quorum</span> <span class="s1">&#39;from breed&#39;</span><span class="p">,</span> <span class="ss">:needs</span> <span class="o">=&gt;</span> <span class="ss">:breed</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="o">|</span>
              <span class="n">characteristics</span><span class="o">[</span><span class="ss">:breed</span><span class="o">].</span><span class="n">weight</span>
            <span class="k">end</span>
      
            <span class="n">quorum</span> <span class="s1">&#39;from species&#39;</span><span class="p">,</span> <span class="ss">:needs</span> <span class="o">=&gt;</span> <span class="ss">:species</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="o">|</span>
              <span class="n">characteristics</span><span class="o">[</span><span class="ss">:species</span><span class="o">].</span><span class="n">weight</span>
            <span class="k">end</span>
      
            <span class="n">quorum</span> <span class="s1">&#39;default&#39;</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>sabshere 2/10/11 pulled from Species.fallback
kg</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>              <span class="no">Species</span><span class="o">.</span><span class="n">weighted_average</span> <span class="ss">:weight</span><span class="p">,</span> <span class="ss">:weighted_by</span> <span class="o">=&gt;</span> <span class="ss">:population</span>
            <span class="k">end</span>
          <span class="k">end</span>
          
          <span class="n">committee</span> <span class="ss">:active_subtimeframe</span> <span class="k">do</span>
            <span class="n">quorum</span> <span class="s1">&#39;from acquisition and retirement&#39;</span><span class="p">,</span> <span class="ss">:needs</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:acquisition</span><span class="p">,</span> <span class="ss">:retirement</span><span class="o">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">|</span>
              <span class="no">Timeframe</span><span class="o">.</span><span class="n">constrained_new</span> <span class="n">characteristics</span><span class="o">[</span><span class="ss">:acquisition</span><span class="o">].</span><span class="n">to_date</span><span class="p">,</span> <span class="n">characteristics</span><span class="o">[</span><span class="ss">:retirement</span><span class="o">].</span><span class="n">to_date</span><span class="p">,</span> <span class="n">timeframe</span>
            <span class="k">end</span>
          <span class="k">end</span>
          
          <span class="n">committee</span> <span class="ss">:acquisition</span> <span class="k">do</span>
            <span class="n">quorum</span> <span class="s1">&#39;from retirement&#39;</span><span class="p">,</span> <span class="ss">:appreciates</span> <span class="o">=&gt;</span> <span class="ss">:retirement</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">|</span>
              <span class="o">[</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">from</span><span class="p">,</span> <span class="n">characteristics</span><span class="o">[</span><span class="ss">:retirement</span><span class="o">]</span> <span class="o">].</span><span class="n">compact</span><span class="o">.</span><span class="n">min</span>
            <span class="k">end</span>
          <span class="k">end</span>
          
          <span class="n">committee</span> <span class="ss">:retirement</span> <span class="k">do</span>
            <span class="n">quorum</span> <span class="s1">&#39;from acquisition&#39;</span><span class="p">,</span> <span class="ss">:appreciates</span> <span class="o">=&gt;</span> <span class="ss">:acquisition</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">|</span>
              <span class="o">[</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">to</span><span class="p">,</span> <span class="n">characteristics</span><span class="o">[</span><span class="ss">:acquisition</span><span class="o">]</span> <span class="o">].</span><span class="n">compact</span><span class="o">.</span><span class="n">max</span>
            <span class="k">end</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="no">ANNUAL_VETERINARY_EMISSION</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mo">00437</span><span class="o">.</span><span class="n">tons</span><span class="o">.</span><span class="n">to</span> <span class="ss">:kilograms</span> <span class="c1"># kg CO2e per https://brighterplanet.sifterapp.com/projects/30/issues/846/comments</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
